{"ast":null,"code":"import _toConsumableArray from\"/Users/griffinbaker/Desktop/chat-application/client/node_modules/@babel/runtime/helpers/esm/toConsumableArray.js\";import _regeneratorRuntime from\"/Users/griffinbaker/Desktop/chat-application/client/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";import _asyncToGenerator from\"/Users/griffinbaker/Desktop/chat-application/client/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"/Users/griffinbaker/Desktop/chat-application/client/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import{Fragment,useState,useEffect,useRef}from'react';import{useAuthentication}from'../../contexts/authentication-context';import{useChatView}from'../../contexts/chat-view-context';import{useSocket}from'../../contexts/socket-context';import{TOAST_TYPE,defaultToast}from'../../utils/utils';import SearchResult,{SEARCH_RESULT_TYPE}from'../search-result/search-result-component';import'./add-user-dropdown.styles.scss';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";var AddUserDropdown=function AddUserDropdown(_ref){var wasSoloChat=_ref.wasSoloChat;var _useState=useState([]),_useState2=_slicedToArray(_useState,2),userSearchResults=_useState2[0],setUserSearchResults=_useState2[1];var addUserToChatRef=useRef();var _useAuthentication=useAuthentication(),currentUser=_useAuthentication.currentUser;var _useChatView=useChatView(),activeChat=_useChatView.activeChat,showAddUserInfoDropdown=_useChatView.showAddUserInfoDropdown,chats=_useChatView.chats,setActiveChat=_useChatView.setActiveChat;var _useSocket=useSocket(),socket=_useSocket.socket;useEffect(function(){if(!addUserToChatRef.current)return;addUserToChatRef.current.focus();},[showAddUserInfoDropdown]);var handleTextChange=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(e){var query,response,_yield$response$json,users,usersNotAlreadyInChat;return _regeneratorRuntime().wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:query=e.target.value;if(query){_context.next=4;break;}setUserSearchResults([]);return _context.abrupt(\"return\");case 4:_context.prev=4;_context.next=7;return fetch(\"http://localhost:4000/api/user?search=\".concat(query),{method:'get',headers:{Authorization:\"Bearer \".concat(currentUser.token)}});case 7:response=_context.sent;_context.next=10;return response.json();case 10:_yield$response$json=_context.sent;users=_yield$response$json.users;usersNotAlreadyInChat=users.filter(function(returnedUser){return!activeChat[0].users.some(function(chatUser){return returnedUser.userName===chatUser.userName;});});setUserSearchResults(usersNotAlreadyInChat);_context.next=19;break;case 16:_context.prev=16;_context.t0=_context[\"catch\"](4);defaultToast(TOAST_TYPE.error,'User already exists in chat');case 19:case\"end\":return _context.stop();}}},_callee,null,[[4,16]]);}));return function handleTextChange(_x){return _ref2.apply(this,arguments);};}();// LETS LOOK AT THIS FIRST THING TOMORROW. WHEN YOU CREATE A SOLO CHAT AND THEN ADD SOMEONE TO THE CHAT WITH THAT PERSON, YOU GET WEIRD BEHAVIOR AND THEY GET GROUPED TOGETHER IN THE SAME CHAT. BUT THEN AFTER WE KNOCK THAT OUT, WE JUST DO THE LAST MESSAGES AND WHETHER THEY HAVE BEEN READ (JUST USE STATE AND CHECK WHETHER THEY HAVE BEEN READ; CAN STORE THEM IN AN OBJECT WITH THE MESSAGE, SENDER, TEXT, AND READ STATUS) - WHEN YOU ADD A MESSAGE IT GOES TO UNREAD BUT THEN WHEN YOU CLICK IT GOES TO READ. THEN WE JUST HANDLE NOTIFICATIONS AND WE ARE DONEZO :)\nvar handleAddUser=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee2(e){var closestContainer,selectedId,mappedChatWithNamesAndId,selectedUser,newSearchResults,sortedChatUsers,existingChatUsersAndId,existingChat,response,newChat;return _regeneratorRuntime().wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:closestContainer=e.target.closest('.add-user-to-existing-chat-container');selectedId=closestContainer.getAttribute('name');mappedChatWithNamesAndId=chats.map(function(chat){return[chat.users.map(function(_ref4){var userName=_ref4.userName;return userName;}).sort(),chat._id];});selectedUser=userSearchResults.find(function(user){return user._id===selectedId;});newSearchResults=userSearchResults.filter(function(user){return user._id!==selectedUser._id;});setUserSearchResults(newSearchResults);sortedChatUsers=[].concat(_toConsumableArray(activeChat[0].users),[selectedUser]).map(function(user){return user.userName;}).sort();existingChatUsersAndId=mappedChatWithNamesAndId.find(function(chat){if(chat[0].length!==sortedChatUsers.length)return false;return chat[0].every(function(user,i){return user===sortedChatUsers[i];});});if(!existingChatUsersAndId){_context2.next=12;break;}existingChat=chats.find(function(chat){return chat._id===existingChatUsersAndId[1];});setActiveChat([existingChat]);return _context2.abrupt(\"return\");case 12:_context2.prev=12;_context2.next=15;return fetch('http://localhost:4000/api/chat/addUserToChat',{method:'put',headers:{Authorization:\"Bearer \".concat(currentUser.token),'Content-Type':'application/json'},body:JSON.stringify({chatId:activeChat[0]._id,userId:selectedId})});case 15:response=_context2.sent;_context2.next=18;return response.json();case 18:newChat=_context2.sent;if(!newChat.latestMessage){socket.emit('chat update',newChat,currentUser,null,true);}else{socket.emit('chat update',newChat,null,null,true);}defaultToast(TOAST_TYPE.success,'User successfully added');_context2.next=26;break;case 23:_context2.prev=23;_context2.t0=_context2[\"catch\"](12);defaultToast(TOAST_TYPE.failure,'Error adding user');case 26:case\"end\":return _context2.stop();}}},_callee2,null,[[12,23]]);}));return function handleAddUser(_x2){return _ref3.apply(this,arguments);};}();return/*#__PURE__*/_jsx(\"div\",{className:\"add-user-dropdown-container\",children:/*#__PURE__*/_jsx(\"div\",{className:\"add-user-dropdown-tip bottom\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"add-user-dropdown-content-container\",children:[/*#__PURE__*/_jsx(\"input\",{type:\"search\",placeholder:\"Search users...\",onChange:handleTextChange,ref:addUserToChatRef}),/*#__PURE__*/_jsx(\"div\",{className:\"add-user-dropdown-results-container\",children:userSearchResults.map(function(searchResult,i){return/*#__PURE__*/_jsx(Fragment,{children:/*#__PURE__*/_jsx(SearchResult,{type:SEARCH_RESULT_TYPE.addUserToExistingChat,handleAddUser:handleAddUser,searchResult:searchResult})},i);})})]})})});};export default AddUserDropdown;","map":{"version":3,"names":["Fragment","useState","useEffect","useRef","useAuthentication","useChatView","useSocket","TOAST_TYPE","defaultToast","SearchResult","SEARCH_RESULT_TYPE","AddUserDropdown","wasSoloChat","userSearchResults","setUserSearchResults","addUserToChatRef","currentUser","activeChat","showAddUserInfoDropdown","chats","setActiveChat","socket","current","focus","handleTextChange","e","query","target","value","fetch","method","headers","Authorization","token","response","json","users","usersNotAlreadyInChat","filter","returnedUser","some","chatUser","userName","error","handleAddUser","closestContainer","closest","selectedId","getAttribute","mappedChatWithNamesAndId","map","chat","sort","_id","selectedUser","find","user","newSearchResults","sortedChatUsers","existingChatUsersAndId","length","every","i","existingChat","body","JSON","stringify","chatId","userId","newChat","latestMessage","emit","success","failure","searchResult","addUserToExistingChat"],"sources":["/Users/griffinbaker/Desktop/chat-application/client/src/components/add-user-dropdown/add-user-dropdown.component.jsx"],"sourcesContent":["import { Fragment, useState, useEffect, useRef } from 'react';\nimport { useAuthentication } from '../../contexts/authentication-context';\nimport { useChatView } from '../../contexts/chat-view-context';\nimport { useSocket } from '../../contexts/socket-context';\nimport { TOAST_TYPE, defaultToast } from '../../utils/utils';\nimport SearchResult, {\n  SEARCH_RESULT_TYPE,\n} from '../search-result/search-result-component';\nimport './add-user-dropdown.styles.scss';\n\nconst AddUserDropdown = ({ wasSoloChat }) => {\n  const [userSearchResults, setUserSearchResults] = useState([]);\n  const addUserToChatRef = useRef();\n\n  const { currentUser } = useAuthentication();\n  const { activeChat, showAddUserInfoDropdown, chats, setActiveChat } =\n    useChatView();\n  const { socket } = useSocket();\n\n  useEffect(() => {\n    if (!addUserToChatRef.current) return;\n    addUserToChatRef.current.focus();\n  }, [showAddUserInfoDropdown]);\n\n  const handleTextChange = async e => {\n    const query = e.target.value;\n    if (!query) {\n      setUserSearchResults([]);\n      return;\n    }\n    try {\n      const response = await fetch(\n        `http://localhost:4000/api/user?search=${query}`,\n        {\n          method: 'get',\n          headers: { Authorization: `Bearer ${currentUser.token}` },\n        }\n      );\n      const { users } = await response.json();\n\n      const usersNotAlreadyInChat = users.filter(returnedUser => {\n        return !activeChat[0].users.some(\n          chatUser => returnedUser.userName === chatUser.userName\n        );\n      });\n\n      setUserSearchResults(usersNotAlreadyInChat);\n    } catch (e) {\n      defaultToast(TOAST_TYPE.error, 'User already exists in chat');\n    }\n  };\n\n  // LETS LOOK AT THIS FIRST THING TOMORROW. WHEN YOU CREATE A SOLO CHAT AND THEN ADD SOMEONE TO THE CHAT WITH THAT PERSON, YOU GET WEIRD BEHAVIOR AND THEY GET GROUPED TOGETHER IN THE SAME CHAT. BUT THEN AFTER WE KNOCK THAT OUT, WE JUST DO THE LAST MESSAGES AND WHETHER THEY HAVE BEEN READ (JUST USE STATE AND CHECK WHETHER THEY HAVE BEEN READ; CAN STORE THEM IN AN OBJECT WITH THE MESSAGE, SENDER, TEXT, AND READ STATUS) - WHEN YOU ADD A MESSAGE IT GOES TO UNREAD BUT THEN WHEN YOU CLICK IT GOES TO READ. THEN WE JUST HANDLE NOTIFICATIONS AND WE ARE DONEZO :)\n\n  const handleAddUser = async e => {\n    const closestContainer = e.target.closest(\n      '.add-user-to-existing-chat-container'\n    );\n    const selectedId = closestContainer.getAttribute('name');\n\n    const mappedChatWithNamesAndId = chats.map(chat => [\n      chat.users.map(({ userName }) => userName).sort(),\n      chat._id,\n    ]);\n\n    const selectedUser = userSearchResults.find(\n      user => user._id === selectedId\n    );\n\n    const newSearchResults = userSearchResults.filter(\n      user => user._id !== selectedUser._id\n    );\n\n    setUserSearchResults(newSearchResults);\n\n    const sortedChatUsers = [...activeChat[0].users, selectedUser]\n      .map(user => user.userName)\n      .sort();\n\n    const existingChatUsersAndId = mappedChatWithNamesAndId.find(chat => {\n      if (chat[0].length !== sortedChatUsers.length) return false;\n      return chat[0].every((user, i) => user === sortedChatUsers[i]);\n    });\n\n    if (existingChatUsersAndId) {\n      const existingChat = chats.find(\n        chat => chat._id === existingChatUsersAndId[1]\n      );\n      setActiveChat([existingChat]);\n      return;\n    }\n\n    try {\n      const response = await fetch(\n        'http://localhost:4000/api/chat/addUserToChat',\n        {\n          method: 'put',\n          headers: {\n            Authorization: `Bearer ${currentUser.token}`,\n            'Content-Type': 'application/json',\n          },\n          body: JSON.stringify({\n            chatId: activeChat[0]._id,\n            userId: selectedId,\n          }),\n        }\n      );\n      const newChat = await response.json();\n      if (!newChat.latestMessage) {\n        socket.emit('chat update', newChat, currentUser, null, true);\n      } else {\n        socket.emit('chat update', newChat, null, null, true);\n      }\n      defaultToast(TOAST_TYPE.success, 'User successfully added');\n    } catch (error) {\n      defaultToast(TOAST_TYPE.failure, 'Error adding user');\n    }\n  };\n\n  return (\n    <div className=\"add-user-dropdown-container\">\n      <div className=\"add-user-dropdown-tip bottom\">\n        <div className=\"add-user-dropdown-content-container\">\n          <input\n            type=\"search\"\n            placeholder=\"Search users...\"\n            onChange={handleTextChange}\n            ref={addUserToChatRef}\n          />\n          <div className=\"add-user-dropdown-results-container\">\n            {userSearchResults.map((searchResult, i) => (\n              <Fragment key={i}>\n                <SearchResult\n                  type={SEARCH_RESULT_TYPE.addUserToExistingChat}\n                  handleAddUser={handleAddUser}\n                  searchResult={searchResult}\n                />\n              </Fragment>\n            ))}\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport default AddUserDropdown;\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}